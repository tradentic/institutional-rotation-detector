# `@tradentic/resilient-http-core` — Spec v0.5

**Status:** Draft for implementation  \
**Previous:** v0.4  \
**Scope:** Incremental refinement of cross‑cutting types (AgentContext, correlation IDs, extensions) for the resilient HTTP core. All other v0.4 behaviour (retry semantics, rate limiting hooks, caching hooks, tracing/logging integration, `OPTIONS` support, etc.) remains in force unless explicitly changed here.

---

## 1. Goals for v0.5

v0.5 is a **small but important cleanup release** focused on cross‑cutting types and agent/telemetry integration:

1. **Recenter `AgentContext` around agents, not correlation IDs**  
   - Restore a more natural, agent‑centric shape for `AgentContext` (agent name, run id, labels, metadata) that matches how agentic systems actually think.
   - Remove correlation IDs from `AgentContext` and treat them as first‑class HTTP/telemetry concerns instead.

2. **Introduce explicit HTTP‑level correlation fields**  
   - Add `correlationId` and `parentCorrelationId` directly to `HttpRequestOptions` and telemetry meta types.  
   - Guarantee that whenever `correlationId` is propagated, `parentCorrelationId` is also propagated when present.

3. **De‑duplicate overlapping concepts across types**  
   - Remove the `attributes` field from `AgentContext` (added in v0.4) to avoid overlap with the existing `extensions` bag and future agent‑conversation libraries.  
   - Clearly separate:
     - **Agent identity / run context** (`AgentContext`) from
     - **HTTP‑level correlation** (`correlationId`, `parentCorrelationId`) from
     - **Per‑request plugin metadata** (`extensions`).

4. **Keep the core clean and ready for satellite libraries**  
   - Make sure `@tradentic/resilient-http-core` remains agnostic of any specific AI/LLM provider or conversation model.  
   - Design the types so that a future `@airnub/agent-conversation-core` can layer on top cleanly, using `AgentContext`, `correlationId` and `extensions` without forcing changes to the core.


---

## 2. High‑level Design Changes vs v0.4

### 2.1 `AgentContext` is agent‑centric again

**Previous (pre‑v0.4):**

```ts
export interface AgentContext {
  agent?: string;
  runId?: string;
  labels?: Record<string, string>;
  metadata?: Record<string, unknown>;
}
```

**v0.4 shape (implemented in PR #89):**

```ts
export interface AgentContext {
  correlationId?: string;
  parentCorrelationId?: string;
  source?: string;
  attributes?: Record<string, string | number | boolean>;
}
```

**v0.5 (final) shape:**

```ts
export interface AgentContext {
  /**
   * Logical name/identifier of the calling agent, component, or workflow.
   * Examples:
   *   - "rotation-score-scanner"
   *   - "temporal-worker"
   *   - "wellknown-catalog-builder"
   */
  agent?: string;

  /**
   * Stable identifier for the current agent run / job / workflow / conversation.
   * Examples:
   *   - a Temporal workflow ID / run ID
   *   - a background job ID
   *   - a high-level agent "task id"
   */
  runId?: string;

  /**
   * Low-cardinality tags describing this agent run.
   * Examples:
   *   - { env: "prod", lane: "backtest", feature: "rotation-score" }
   *   - { tenant: "demo", region: "eu-west-1" }
   */
  labels?: Record<string, string>;

  /**
   * Opaque metadata bag for agent frameworks and higher-level tooling.
   * The HTTP core does not interpret this; it may include provider-specific
   * or workflow-specific details if the caller chooses.
   */
  metadata?: Record<string, unknown>;
}
```

Key points:

- `AgentContext` **no longer contains** `correlationId` or `parentCorrelationId`. Those belong to the HTTP/telemetry layer (see §2.2).
- `AgentContext` is intentionally unaware of LLM conversation concepts like `response_id` or `previous_response_id`. Those live in satellite libraries (e.g. `@airnub/agent-conversation-core`) and, when needed, flow through via `AgentContext.metadata` or `HttpRequestOptions.extensions`.


### 2.2 HTTP‑level correlation lives on `HttpRequestOptions`

Introduce explicit correlation fields on the core request type and propagate them everywhere telemetry is emitted.

**New fields on `HttpRequestOptions`:**

```ts
export interface HttpRequestOptions {
  method: HttpMethod;
  path: string;
  // existing fields: query, headers, body, operation, etc.

  /**
   * Per-request identifier (may be generated by the core when omitted).
   * Already present in v0.4; included here for clarity.
   */
  requestId?: string;

  /**
   * Logical correlation identifier spanning one or more HTTP calls.
   * This is *not* the same as AgentContext.runId; it is used for
   * cross-service observability (logs, traces, metrics).
   */
  correlationId?: string;

  /**
   * Optional parent correlation identifier, for multi-layer workflows.
   * If present, it must be propagated alongside `correlationId` to
   * all telemetry and policy hooks.
   */
  parentCorrelationId?: string;

  /**
   * Agent-level context for this request (see AgentContext above).
   */
  agentContext?: AgentContext;

  /**
   * Opaque extension metadata for high-level libraries and plugins.
   * The core never interprets this. It is surfaced into telemetry and
   * policy hooks for external consumers.
   */
  extensions?: Record<string, unknown>;

  // ... all other v0.4 fields remain unchanged
}
```

**Propagation guarantee:**

- Wherever the core forwards `correlationId` in telemetry meta structures, it **must also forward `parentCorrelationId` when present**.
- This applies to:
  - metrics (e.g. `MetricsRequestInfo`),
  - logging meta (e.g. `LoggerMeta`),
  - tracing (e.g. attributes provided to `TracingAdapter.startSpan`),
  - policy/rate-limiter contexts (where applicable).


### 2.3 De-duping `AgentContext.attributes` vs `extensions`

v0.4 introduced `AgentContext.attributes` **and** `HttpRequestOptions.extensions`, which overlap conceptually (both are bags of arbitrary key/value metadata that the core passes through).

v0.5 resolves this by:

- **Removing** `attributes` from `AgentContext`.
- Retaining the more general `metadata` bag for agent use.
- Keeping `extensions` as the canonical **per-request plugin/extension bag**.

**Intended usage boundary:**

- `AgentContext` → "who/what is making this request, and which run of that agent is this?"  
  - Stable across many HTTP calls in a run.
  - Semantic to the agent framework.

- `extensions` → "extra per-request metadata for plugins, policies, and satellite libraries"
  - Can change from call to call (e.g. different LLM provider/model, per-call budget info, etc.).
  - May be used heavily by `@airnub/agent-conversation-core`, `@airnub/resilient-http-policies`, etc.


---

## 3. Updated Core Types

This section defines the updated shapes for the core types impacted by v0.5. All other types from v0.4 remain unchanged unless noted.

### 3.1 `AgentContext`

As in §2.1, this is the canonical v0.5 version:

```ts
export interface AgentContext {
  agent?: string;
  runId?: string;
  labels?: Record<string, string>;
  metadata?: Record<string, unknown>;
}
```


### 3.2 `HttpRequestOptions`

v0.5 extends the v0.4 shape with correlation fields and clarifies the use of `agentContext` and `extensions`.

> **Note:** Only the relevant parts are shown here; implementers must merge this with the full v0.4 definition in code.

```ts
export interface HttpRequestOptions {
  /** HTTP verb (now includes OPTIONS via v0.4). */
  method: HttpMethod;

  /** Path relative to the client's base URL, e.g. "/v1/chat/completions". */
  path: string;

  /** Optional query string parameters. */
  query?: Record<string, string | number | boolean | null | undefined>;

  /** Request headers; keys must be normalized by the caller if necessary. */
  headers?: Record<string, string>;

  /** JSON-serializable body or transport-specific payload. */
  body?: unknown;

  /**
   * Logical operation name for observability (e.g. "finra.weeklySummary").
   * Required for meaningful logs/metrics; may default to the path.
   */
  operation?: string;

  /** Optional explicit idempotency flag; otherwise derived from method. */
  idempotent?: boolean;

  /** Client-provided request identifier for this HTTP call. */
  requestId?: string;

  /** Cross-service correlation ID for observability. */
  correlationId?: string;

  /** Parent correlation ID for hierarchical workflows (optional). */
  parentCorrelationId?: string;

  /** Agent identity / run metadata for this call. */
  agentContext?: AgentContext;

  /**
   * Opaque per-request extension metadata for plugins and satellite libs.
   * The core must not rely on any specific keys.
   */
  extensions?: Record<string, unknown>;

  /** Cache key and TTL (ms), if applicable. */
  cacheKey?: string;
  cacheTtlMs?: number;

  /**
   * Optional timeout override for this request (ms). If omitted, the
   * client-level default applies.
   */
  timeoutMs?: number;

  /** Optional override for maximum retries for this request. */
  maxRetries?: number;

  /** Optional AbortSignal for cancellation. */
  signal?: AbortSignal;

  // Any other v0.4 fields (e.g., policy hooks, budgets) remain unchanged.
}
```

### 3.3 `MetricsRequestInfo`

Ensure the metrics meta structure includes both correlation IDs and agent/extension info.

```ts
export interface MetricsRequestInfo {
  client: string;      // logical client name, e.g. "finra", "openai", "sec"
  operation: string;   // same as HttpRequestOptions.operation
  durationMs: number;
  status: number;
  cacheHit?: boolean;
  attempt?: number;    // 0-based retry attempt index

  /** Correlation IDs from HttpRequestOptions. */
  correlationId?: string;
  parentCorrelationId?: string;

  /** Per-request ID, if provided. */
  requestId?: string;

  /** Agent-level context (v0.5 shape). */
  agentContext?: AgentContext;

  /** Opaque per-request extensions. */
  extensions?: Record<string, unknown>;
}
```

**Propagation rule:**

- The `HttpClient` implementation **must** populate `correlationId` and `parentCorrelationId` in `MetricsRequestInfo` whenever they are present on `HttpRequestOptions`.


### 3.4 Logging meta (`baseLogMeta` / logger usage)

Wherever the core constructs log meta (e.g. via `baseLogMeta(opts)`), ensure the following:

- `correlationId`, `parentCorrelationId`, and `requestId` are included.
- `agentContext` is included as a nested object (not flattened by default).
- `extensions` may be included as-is for debugging, but callers should understand that this may be verbose.

A typical shape:

```ts
interface LoggerMeta {
  client: string;
  operation: string;
  method: HttpMethod;
  path: string;
  status?: number;
  attempt?: number;
  durationMs?: number;

  requestId?: string;
  correlationId?: string;
  parentCorrelationId?: string;

  agentContext?: AgentContext;
  extensions?: Record<string, unknown>;
}
```

Exact structure is implementation-defined, but the **presence and propagation** of these fields is required.


### 3.5 Tracing integration (`TracingAdapter`)

When starting a span, v0.5 requires the core to:

- Add the following attributes:
  - `client`: client name
  - `operation`: operation name
  - `method`: HTTP method
  - `path`: HTTP path
  - `requestId` (nullable if absent)
  - `correlation_id` (if provided)
  - `parent_correlation_id` (if provided)
  - `agent.name` (from `agentContext.agent`)
  - `agent.run_id` (from `agentContext.runId`)
  - `agent.label.<key>` for each `labels[key]` in `AgentContext`
- Pass through `agentContext` and `extensions` to the tracing adapter options without interpreting them.

Example (conceptual):

```ts
const attributes: Record<string, string | number | boolean | null> = {
  client: this.clientName,
  operation: opts.operation,
  method: opts.method,
  path: opts.path,
  requestId: opts.requestId ?? null,
};

if (opts.correlationId) {
  attributes["correlation_id"] = opts.correlationId;
}
if (opts.parentCorrelationId) {
  attributes["parent_correlation_id"] = opts.parentCorrelationId;
}

const agent = opts.agentContext;
if (agent?.agent) {
  attributes["agent.name"] = agent.agent;
}
if (agent?.runId) {
  attributes["agent.run_id"] = agent.runId;
}
if (agent?.labels) {
  for (const [key, value] of Object.entries(agent.labels)) {
    attributes[`agent.label.${key}`] = value;
  }
}

return this.config.tracing?.startSpan(`${this.clientName}.${opts.operation}`, {
  attributes,
  agentContext: opts.agentContext,
  extensions: opts.extensions,
});
```

> **Note:** The tracing adapter remains pluggable and OTEL-agnostic. A separate library (e.g. `@airnub/resilient-http-otel`) can interpret `agentContext` and `extensions` more deeply if desired.


---

## 4. Interplay with Satellite Libraries

v0.5 is intentionally designed so the core can remain small and agnostic while future libraries add AI/agent-specific behaviour.

### 4.1 `@airnub/agent-conversation-core` (future)

- Will likely:
  - Manage multi-provider conversation state (OpenAI, Anthropic, Google, etc.).
  - Track `response_id`, `previous_response_id`, conversation trees, etc.
- Such a library **must not** require changes in `@tradentic/resilient-http-core`. Instead, it should:
  - Use `AgentContext` to identify the agent and run.
  - Use `HttpRequestOptions.correlationId` / `parentCorrelationId` for cross-service observability.
  - Store conversation-specific details in:
    - `AgentContext.metadata` (for high-level run metadata), and/or
    - `HttpRequestOptions.extensions` (for per-request, per-provider details).

### 4.2 `@airnub/resilient-http-policies` and `@airnub/resilient-http-pagination`

- Policy libraries can rely on the correlation fields and `AgentContext` to:
  - Implement per-run budgets.
  - Vary policy behaviour by agent/feature labels.
- Pagination helpers can treat `AgentContext` as opaque, simply forwarding it to each page request for consistent tagging.

v0.5 provides the **stable hooks** these libraries depend on without pulling their concerns into the core.


---

## 5. Implementation Plan for v0.5

This section is written for the coding agent / developer implementing the spec.

### 5.1 Update `AgentContext` type

1. In `libs/resilient-http-core/src/types.ts` (or equivalent):
   - Replace the v0.4 `AgentContext` shape with the v0.5 version:

   ```ts
   export interface AgentContext {
     agent?: string;
     runId?: string;
     labels?: Record<string, string>;
     metadata?: Record<string, unknown>;
   }
   ```

2. Remove any references to `correlationId`, `parentCorrelationId`, `source`, or `attributes` inside `AgentContext`.

3. Fix any compilation errors in the core and dependent packages (FINRA client, Unusual Whales client, OpenAI client, SEC client, IEX client, Temporal worker, etc.) by updating their imports/usage of `AgentContext`.


### 5.2 Add correlation fields to `HttpRequestOptions`

1. In `HttpRequestOptions` definition, add:

   ```ts
   requestId?: string;
   correlationId?: string;
   parentCorrelationId?: string;
   agentContext?: AgentContext;
   extensions?: Record<string, unknown>;
   ```

   (Retain any existing `requestId` field; do not duplicate.)

2. Replace any previous correlation-related logic that fetched these values from `AgentContext` with direct use of `HttpRequestOptions.correlationId` and `HttpRequestOptions.parentCorrelationId`.


### 5.3 Propagate correlation IDs into telemetry

1. **Metrics:**
   - Update `MetricsRequestInfo` to include `correlationId`, `parentCorrelationId`, and `requestId` fields as shown in §3.3.
   - Ensure `HttpClient` populates these values from `HttpRequestOptions`.

2. **Logging:**
   - Update `baseLogMeta` (or equivalent) to include `correlationId`, `parentCorrelationId`, and `requestId` in the log meta.

3. **Tracing:**
   - Update `startSpan` helper to add the correlation attributes as shown in §3.5.
   - Ensure `agentContext` and `extensions` are passed through unchanged to the tracing adapter.


### 5.4 Map AgentContext fields into trace attributes

1. In the tracing bridge, map:
   - `AgentContext.agent` → `agent.name`
   - `AgentContext.runId` → `agent.run_id`
   - `AgentContext.labels[key]` → `agent.label.<key>`

2. Keep `metadata` opaque by default (do not flatten). The tracing adapter or higher-level OTEL library may choose to interpret it.


### 5.5 Clean up old v0.4 assumptions

1. Remove any code that expects `AgentContext` to contain `correlationId` / `parentCorrelationId` / `attributes`.
2. Adjust tests in `libs/resilient-http-core/src/__tests__/HttpClient.test.ts`:
   - Update any AgentContext-related tests to use `agent`, `runId`, `labels`, `metadata`.
   - Add tests verifying that `correlationId` and `parentCorrelationId` propagate correctly from `HttpRequestOptions` into metrics/logging/tracing.


### 5.6 Build & test

From the repo root:

```bash
pnpm --filter @tradentic/resilient-http-core test
pnpm --filter @tradentic/resilient-http-core build

pnpm --filter @libs/finra-client build
pnpm --filter @libs/unusualwhales-client build
pnpm --filter @libs/openai-client build
pnpm --filter rotation-detector-temporal-worker build
```

Fix any type or test failures until all of the above succeed.


---

## 6. Non-goals / Out of Scope for v0.5

- No changes to retry/backoff semantics, HTTP methods (including `OPTIONS`), or caching/rate limiting behaviour.
- No introduction of provider-specific AI/LLM fields (e.g. `response_id`, `previous_response_id`) into the core types.
- No direct dependency on OTEL, Temporal, or any specific tracing/logging/metrics library.
- No changes to the public surface of FINRA, Unusual Whales, OpenAI, SEC, or IEX client libraries beyond whatever is needed to consume the updated core types.

v0.5 is strictly a **type and telemetry wiring cleanup** to keep the HTTP core small, coherent, and ready for richer agent- and conversation-focused satellite libraries.