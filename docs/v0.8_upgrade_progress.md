# Resilient HTTP Core v0.8 Upgrade Progress

## Status: IN PROGRESS

## Completed Work

### Phase 1: Inventory ‚úÖ
- Read and analyzed v0.8 spec document
- Inventoried current v0.7 implementation
- Created detailed comparison between v0.7 and v0.8

### Phase 2: Type Alignment ‚úÖ
Updated `libs/resilient-http-core/src/types.ts` with v0.8 types:

1. **HttpCache** - Updated to use `HttpCacheEntry<T>` with expiration timestamps
2. **QueryParams** - New type for URL query parameters
3. **UrlParts** - Aligned to v0.8 spec
4. **CorrelationInfo** - Made `requestId` optional
5. **RequestClass** - New type for request classification
6. **AgentContext** - Updated with v0.8 fields (`agentName`, `tenantId`, `requestClass`, etc.) while preserving v0.7 fields as deprecated
7. **ResilienceProfile** - Added `jitterFactor`, `retryIdempotentMethodsByDefault`, `maxSuggestedRetryDelayMs`
8. **BudgetHints** - New v0.8 interface for token/cost tracking
9. **ErrorCategory** - Aligned to v0.8 categories
10. **FallbackHint** - Updated structure
11. **ClassifiedError** - Added `fallback` field, deprecated legacy fields
12. **RawHttpResponse** - New v0.8 transport response type
13. **ErrorClassifierContext** - New v0.8 context for unified classify method
14. **ErrorClassifier** - Added unified `classify(ctx)` method, deprecated legacy methods
15. **RateLimitFeedback** - Aligned field names to v0.8
16. **RequestOutcome** - Changed `startedAt/finishedAt` to `Date`, added `durationMs`, `statusFamily`, `errorMessage`
17. **MetricsRequestInfo** - Now requires `outcome` field
18. **TransportRequest** - New v0.8 transport request structure
19. **HttpTransport** - Updated signature to v0.8 spec
20. **TracingSpan** - Updated to v0.8 signature (no `end()` method)
21. **TracingAdapter** - Updated to `startSpan(info)` / `endSpan(span, outcome)`
22. **HttpClientConfig** - Made `clientName` optional, added `defaultExtensions`, `metricsSink`, `tracingAdapter`
23. **HttpRequestOptions** - Made `operation` optional, added `cacheMode`, changed `budget` to `BudgetHints`
24. **HttpResponse<T>** - New v0.8 response wrapper type
25. **Interceptor Contexts** - Updated `BeforeSendContext`, `AfterResponseContext`, `OnErrorContext`
26. **HttpRequestInterceptor** - Updated to v0.8 signatures

All deprecated v0.7 fields are preserved for backwards compatibility.

### Phase 3: Transport Layer ‚úÖ
Updated transport implementations to v0.8 signatures:

1. **fetchTransport** - Now converts fetch Response to RawHttpResponse with ArrayBuffer body
2. **createAxiosTransport** - Updated to use v0.8 TransportRequest/RawHttpResponse

## In Progress

### Phase 4: HttpClient.ts Updates üîÑ
Started updating HttpClient implementation:

1. ‚úÖ Updated DefaultErrorClassifier to v0.8 unified classify interface
2. ‚ö†Ô∏è Multiple compilation errors due to type mismatches

## Remaining Work

### Phase 4 Continuation: HttpClient.ts
**Key Challenges:**
- Transport signature mismatch (expects TransportRequest, not url + init)
- MetricsRequestInfo requires outcome field
- RequestOutcome uses Date not number for timestamps
- TracingSpan API changed (no end() method)
- HttpCache interface changed
- Interceptor signatures changed
- BudgetHints vs RequestBudget field migrations

**Strategy:**
1. Create internal adapter layer to bridge v0.7 Response ‚Üî v0.8 RawHttpResponse
2. Build RequestOutcome at end of retry loop
3. Update metrics emission to include outcome
4. Update tracing to use new TracingAdapter API
5. Keep existing public method signatures (requestJson returns T, not HttpResponse<T>)
6. Add new *Response methods that return HttpResponse<T>

### Phase 5: ErrorClassifier Migration
- Ensure all error classification code uses new unified classify(ctx)
- Preserve backwards compat with legacy classifyNetworkError/classifyResponse

### Phase 6: New Helper Methods
Add v0.8 response-returning helpers:
- `requestJsonResponse<T>(): Promise<HttpResponse<T>>`
- `requestTextResponse(): Promise<HttpResponse<string>>`
- `requestArrayBufferResponse(): Promise<HttpResponse<ArrayBuffer>>`
- `requestRawResponse(): Promise<HttpResponse<RawHttpResponse>>`

Keep existing helpers unchanged:
- `requestJson<T>()` continues to return `Promise<T>`
- `requestText()` continues to return `Promise<string>`
- `requestArrayBuffer()` continues to return `Promise<ArrayBuffer>`
- `requestRaw()` continues to return `Promise<Response>`

### Phase 7: Standard Interceptors
Create new interceptor factories:
- `createAuthInterceptor(opts)`
- `createJsonBodyInterceptor(opts)`
- `createIdempotencyInterceptor(opts)`

### Phase 8: Caching Updates
- Update internal caching logic to use HttpCacheEntry
- Preserve backwards compat for any existing cache implementations

### Phase 9: Metrics & Tracing
- Ensure all metrics calls include RequestOutcome
- Update tracing to use v0.8 TracingAdapter signature
- Maintain backwards compat with legacy tracing implementations

### Phase 10: createDefaultHttpClient
- Update factory to match v0.8 spec
- Ensure sensible defaults

### Phase 11-14: Testing & Deployment
- Run full TypeScript build
- Fix remaining type errors
- Run test suite
- Update tests as needed
- Commit and push

## Design Decisions

### Backwards Compatibility Approach
- **Deprecated fields**: Kept in type definitions with @deprecated JSDoc tags
- **Legacy methods**: Preserved with compatibility wrappers
- **New methods**: Added alongside existing ones (additive approach)
- **Type changes**: Use union types and optional fields to support both v0.7 and v0.8 usage

### Migration Path for Consumers
Consumers can migrate incrementally:
1. Continue using existing methods (no breaking changes)
2. Gradually adopt new *Response methods for richer outcome data
3. Update to new type shapes (BudgetHints, etc.) when ready
4. Eventually remove usage of deprecated fields

## Notes
- Following spec section 13 "Migration from v0.7 ‚Üí v0.8" as guidance
- Preserving ALL v0.7 behaviors per prompt requirements
- Treating v0.8 as evolution, not rewrite
- All changes are shape-only or additive, not behavioral
